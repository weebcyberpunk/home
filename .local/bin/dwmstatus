#!/usr/bin/sh

# author GG weebcyberpunk@gmail.com
# version 0.0.0
# since Jul 05, 2022

# sets my dwm bar, now readable

BAT_NOTIFIED="no"
BAT_ALERTED="no"

# MPD {{{
function mpd_widget {
	echo -n " "

	MPD_ARTIST="$(mpc -f '%artist%' current)"
	MPD_SONG="$(mpc -f '%title%' current)"
	MPD_STATUS="$(mpc status '%state%')"

	if [ "$MPD_ARTIST" = "" ]
	then
		echo -n "nothing playing"

	else
		if [ "$MPD_ARTIST" = "Various" ]
		then
			echo -n "$MPD_SONG"
		else
			echo -n "$MPD_ARTIST - $MPD_SONG"
		fi

		if [ "$MPD_STATUS" == "playing" ]
		then
			echo -n " 契"
		else
			echo -n " "
		fi
	fi

}
# }}}

# SYS {{{
function sys_widget {
	echo -n " $(pamixer --get-volume-human)"

	# battery and integrated notify
	BATTERY=$(cat /sys/class/power_supply/BAT1/capacity 2> /dev/null) || return
	
	CHARGING="$(cat /sys/class/power_supply/BAT1/status)"

	if [ $CHARGING == "Charging" ]
	then
		echo -n "  $BATTERY%"
		BAT_NOTIFIED="no"
		BAT_ALERTED="no"

	else

		if [ $BATTERY -gt 80 ]
		then
			echo -n "  $BATTERY%"

		elif [ $BATTERY -gt 60 ]
		then
			echo -n "  $BATTERY%"

		elif [ $BATTERY -gt 40 ]
		then
			echo -n "  $BATTERY%"

		elif [ $BATTERY -gt 20 ]
		then
			echo -n "  $BATTERY%"

		elif [ $BATTERY -gt 10 ]
		then
			echo -n "  $BATTERY%"
			if [ "$BAT_NOTIFIED" == "no" ]
			then
				notify-send 'Low battery level.' 'Battery level is below 20%. Please connect the computer to the charger.'
				BAT_NOTIFIED="yes"
			fi

		else
			echo -n "  $BATTERY%"
			if [ "$BAT_ALERTED" == "no" ]
			then
				notify-send --urgency=critical 'Critical battery level.' 'Battery level is below 10%. Please connect the computer to the charger immediately.'
				mpv --no-video $HOME/.local/share/battery-alert.mp3
				BAT_ALERTED="yes"
			fi
			
		fi

	fi
}
# }}}

function clock_widget {
	date +' %a %b %d  %H:%M'
}

while :
do
	xsetroot -name " $(mpd_widget)   $(sys_widget)   $(clock_widget) "
	sleep 1m
done
